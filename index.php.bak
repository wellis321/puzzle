<?php
require_once 'config.php';
require_once 'includes/Database.php';
require_once 'includes/Session.php';
require_once 'includes/Puzzle.php';
require_once 'includes/Game.php';

$session = new Session();
$puzzle = new Puzzle();
$game = new Game($session->getSessionId());

// Get today's puzzle
$todaysPuzzle = $puzzle->getTodaysPuzzle();

if (!$todaysPuzzle) {
    die('No puzzle available for today. Please check back later!');
}

$puzzleId = $todaysPuzzle['id'];
$statements = $puzzle->getStatements($puzzleId);
$hints = $puzzle->getHints($puzzleId);

// Check if user has already completed this puzzle
$completion = $game->getCompletion($puzzleId);
$attempts = $game->getAttempts($puzzleId);
$attemptCount = count($attempts);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo APP_NAME; ?> - Daily Mystery Puzzle</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üîç <?php echo APP_NAME; ?></h1>
            <p class="tagline">Solve the daily mystery</p>
        </header>

        <main class="game-container">
            <?php if ($completion): ?>
                <!-- Completed State -->
                <div class="completion-screen">
                    <h2><?php echo $completion['solved'] ? 'üéâ Case Solved!' : 'üîç Case Closed'; ?></h2>

                    <?php
                    $scoreEmoji = [
                        'perfect' => 'üß†',
                        'close' => 'üîç',
                        'lucky' => 'üò¨'
                    ];
                    $scoreText = [
                        'perfect' => 'Perfect Deduction',
                        'close' => 'Close Call',
                        'lucky' => 'Lucky Guess'
                    ];
                    ?>

                    <div class="score">
                        <span class="score-emoji"><?php echo $scoreEmoji[$completion['score']]; ?></span>
                        <span class="score-text"><?php echo $scoreText[$completion['score']]; ?></span>
                    </div>

                    <div class="attempts-display">
                        <?php
                        foreach ($attempts as $attempt) {
                            echo $attempt['is_correct'] ? 'üü©' : '‚¨ú';
                        }
                        ?>
                    </div>

                    <?php
                    $solution = $puzzle->getSolution($puzzleId);
                    if ($solution):
                    ?>
                        <div class="solution">
                            <h3>The Solution</h3>
                            <p><strong>Why it doesn't fit:</strong></p>
                            <p><?php echo nl2br(htmlspecialchars($solution['explanation'])); ?></p>

                            <details style="margin-top: 20px;">
                                <summary style="cursor: pointer; font-weight: bold;">Show detailed reasoning</summary>
                                <p style="margin-top: 10px;"><?php echo nl2br(htmlspecialchars($solution['detailed_reasoning'])); ?></p>
                            </details>
                        </div>
                    <?php endif; ?>

                    <div class="share-section">
                        <h3>Share Your Result</h3>
                        <div class="share-box">
                            <textarea id="share-text" readonly><?php echo $game->getShareableResult($puzzleId, 1); ?></textarea>
                            <button onclick="copyShare()" class="btn">üìã Copy to Clipboard</button>
                        </div>
                    </div>

                    <div class="next-puzzle">
                        <p>Next case in:</p>
                        <div id="countdown" class="countdown"></div>
                    </div>
                </div>

            <?php else: ?>
                <!-- Active Game -->
                <div class="puzzle-info">
                    <div class="info-row">
                        <span class="difficulty-badge difficulty-<?php echo $todaysPuzzle['difficulty']; ?>">
                            <?php echo ucfirst($todaysPuzzle['difficulty']); ?>
                        </span>
                        <span class="theme"><?php echo htmlspecialchars($todaysPuzzle['theme']); ?></span>
                    </div>
                    <h2><?php echo htmlspecialchars($todaysPuzzle['title']); ?></h2>
                </div>

                <div class="case-summary">
                    <p><?php echo nl2br(htmlspecialchars($todaysPuzzle['case_summary'])); ?></p>
                </div>

                <div class="report">
                    <h3>The Report</h3>
                    <div class="report-content">
                        <?php
                        // Simple markdown-like formatting
                        $reportText = $todaysPuzzle['report_text'];
                        $reportText = preg_replace('/\*\*(.*?)\*\*/', '<strong>$1</strong>', $reportText);
                        $reportText = nl2br($reportText);
                        echo $reportText;
                        ?>
                    </div>
                </div>

                <div class="task">
                    <h3>Find the ONE detail that doesn't fit</h3>
                    <p class="attempts-remaining">Attempts remaining: <strong><?php echo 3 - $attemptCount; ?></strong></p>
                </div>

                <div class="statements" id="statements">
                    <?php foreach ($statements as $stmt): ?>
                        <button class="statement-btn" data-statement-id="<?php echo $stmt['id']; ?>">
                            <span class="statement-number"><?php echo $stmt['statement_order']; ?></span>
                            <span class="statement-text"><?php echo htmlspecialchars($stmt['statement_text']); ?></span>
                        </button>
                    <?php endforeach; ?>
                </div>

                <?php if ($attemptCount > 0): ?>
                    <div class="hints-section">
                        <h3>Hints</h3>
                        <?php
                        $availableHints = min($attemptCount, count($hints));
                        for ($i = 0; $i < $availableHints; $i++):
                        ?>
                            <div class="hint">
                                üí° <?php echo htmlspecialchars($hints[$i]['hint_text']); ?>
                            </div>
                        <?php endfor; ?>
                    </div>
                <?php endif; ?>

                <div id="feedback" class="feedback"></div>
            <?php endif; ?>
        </main>

        <footer class="footer">
            <p>A new mystery every day at midnight</p>
        </footer>
    </div>

    <script>
        const puzzleId = <?php echo $puzzleId; ?>;
        const isCompleted = <?php echo $completion ? 'true' : 'false'; ?>;

        // Handle statement clicks
        document.querySelectorAll('.statement-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (this.disabled) return;

                const statementId = this.dataset.statementId;

                // Disable all buttons
                document.querySelectorAll('.statement-btn').forEach(b => b.disabled = true);

                try {
                    const response = await fetch('api/submit-answer.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            puzzle_id: puzzleId,
                            statement_id: statementId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        if (result.is_correct) {
                            this.classList.add('correct');
                            showFeedback('üéâ Correct! You found the inconsistency!', 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            this.classList.add('wrong');
                            if (result.attempts_remaining > 0) {
                                showFeedback(`‚ùå Not quite. ${result.attempts_remaining} attempt(s) remaining.`, 'error');
                                // Re-enable buttons
                                setTimeout(() => {
                                    document.querySelectorAll('.statement-btn:not(.wrong)').forEach(b => b.disabled = false);
                                }, 1500);
                            } else {
                                showFeedback('‚ùå Out of attempts. See the solution below.', 'error');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 2000);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showFeedback('An error occurred. Please try again.', 'error');
                    document.querySelectorAll('.statement-btn').forEach(b => b.disabled = false);
                }
            });
        });

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = 'feedback feedback-' + type;
            feedback.style.display = 'block';
        }

        function copyShare() {
            const shareText = document.getElementById('share-text');
            shareText.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }

        // Countdown to next puzzle
        if (isCompleted) {
            function updateCountdown() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);

                const diff = tomorrow - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                document.getElementById('countdown').textContent =
                    `${hours}h ${minutes}m ${seconds}s`;
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }
    </script>
</body>
</html>
